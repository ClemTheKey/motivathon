<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Motivathon — Diagnostic</title>
<style>
:root{--fg:#111;--muted:#666;--ok:#0a0;--bad:#b00}
body{font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:var(--fg);padding:24px}
.card{background:#fff;border:1px solid #e6e6e6;border-radius:14px;padding:18px;max-width:980px;margin:0 auto;box-shadow:0 6px 22px rgba(0,0,0,.06)}
.h{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.small{font-size:12px;color:var(--muted)}
.row{display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:center;margin:10px 0}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccc}
.badge.ok{color:var(--ok);border-color:var(--ok)}
.badge.no{color:var(--bad);border-color:var(--bad)}
pre{background:#f7f7f7;border:1px solid #eee;padding:10px;border-radius:8px;overflow:auto;max-height:280px;white-space:pre-wrap}
code{background:#f3f3f3;padding:2px 4px;border-radius:6px}
.btn{display:inline-block;border:1px solid #ddd;border-radius:10px;padding:6px 10px;background:#fff;cursor:pointer}
.btn:hover{background:#f5f5f5}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv span{padding:2px 6px;border:1px solid #eee;border-radius:6px;background:#fcfcfc}
input[type=text]{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px}
.help{font-size:12px;color:#555;margin-top:-6px;margin-bottom:6px}
hr{border:none;height:1px;background:#eee;margin:14px 0}
</style>
</head>
<body>
<div class="card">
  <div class="h">
    <h2>Motivathon — Diagnostic GitHub Pages / Supabase</h2>
    <div class="small" id="stamp"></div>
  </div>

  <div class="row"><div>URL actuelle</div><div id="loc"></div></div>

  <div class="row"><div>Branche (marqueur BUILD dans index.html)</div><div id="branch" class="badge">inconnue</div></div>

  <div class="row"><div>Scripts trouvés sur <code>index.html</code></div><div><pre id="indexScripts">(analyse…)</pre></div></div>

  <div class="row"><div>Supabase SDK (sur <code>diag.html</code>)</div><div id="sdk" class="badge">…</div></div>

  <div class="row"><div>window.__ENV__ (sur <code>diag.html</code>)</div><div id="env" class="badge">…</div></div>

  <div class="row"><div>Clés de <code>window.Data</code> (sur <code>diag.html</code>)</div><div><pre id="dataKeys">(chargement…)</pre></div></div>

  <div class="row"><div><code>dataService.js</code> contient <code>getUser</code> ?</div><div id="hasGetUser" class="badge">…</div></div>

  <div class="row"><div>Début de <code>dataService.js</code> servi par Pages</div><div><pre id="dsPreview"></pre></div></div>

  <hr>

  <div class="row"><div>Configurer ENV temporaire (facultatif)</div>
    <div>
      <div class="help">Ces valeurs ne modifient pas ton site, elles servent juste à tester depuis cette page.</div>
      <label>SUPABASE_URL</label>
      <input id="envUrl" type="text" placeholder="https://xxxx.supabase.co">
      <label>SUPABASE_ANON_KEY</label>
      <input id="envKey" type="text" placeholder="eyJhbGciOi... (anon key)">
      <div class="kv" style="margin-top:8px">
        <button class="btn" id="btnSetEnv">Définir ENV et initialiser</button>
        <button class="btn" id="btnTestUser">Tester Data.getUser()</button>
        <button class="btn" id="btnRefresh">Data.refresh()</button>
      </div>
      <pre id="envOut"></pre>
    </div>
  </div>

  <hr>

  <div class="row"><div>Outils</div>
    <div class="kv">
      <button class="btn" id="btnReload">Hard reload (no-store)</button>
      <button class="btn" id="btnUnreg">Unregister Service Worker</button>
      <button class="btn" id="btnShowCache">Afficher caches.keys()</button>
    </div>
  </div>

  <div class="row"><div>Caches</div><div><pre id="cachesList"></pre></div></div>
</div>

<!-- 1) Charger le même dataService que le site -->
<script src="dataService.js"></script>

<!-- 2) Charger le SDK Supabase sur diag pour tester localement -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const now = new Date().toISOString();
  $('stamp').textContent = "Diag généré: " + now;
  $('loc').textContent = location.href;

  // Inspecter index.html pour déduire scripts et BUILD
  try {
    const txt = await (await fetch('index.html', {cache:'no-store'})).text();
    const top = txt.slice(0, 1000);
    $('indexScripts').textContent = (top.match(/<script[^>]+src=/gi)||[]).join('\\n') || '(aucun <script> trouvé)';
    const m = txt.match(/BUILD:\\s*([\\-\\w/.@ ]+)/i);
    if (m) {
      $('branch').textContent = m[1];
      $('branch').className = 'badge ok';
    } else {
      $('branch').textContent = 'inconnue (ajoute <!-- BUILD: db-sync --> en haut de index.html)';
      $('branch').className = 'badge no';
    }
  } catch(e) {
    $('indexScripts').textContent = String(e);
    $('branch').textContent = 'introuvable';
    $('branch').className = 'badge no';
  }

  // Supabase SDK présent sur diag ?
  const hasSDK = (typeof window.supabase !== 'undefined');
  $('sdk').textContent = hasSDK ? 'loaded' : 'missing';
  $('sdk').className = 'badge ' + (hasSDK ? 'ok' : 'no');

  // ENV sur diag
  const hasEnv = !!window.__ENV__ && !!window.__ENV__.SUPABASE_URL && !!window.__ENV__.SUPABASE_ANON_KEY;
  $('env').textContent = hasEnv ? 'present' : 'missing/empty';
  $('env').className = 'badge ' + (hasEnv ? 'ok' : 'no');

  // Data keys
  const keys = window.Data ? Object.keys(window.Data) : [];
  $('dataKeys').textContent = (keys.length ? keys.join('\\n') : '(Data manquant — dataService.js non chargé ?)');
  
  // dataService.js: contenu + présence de getUser
  try {
    co
